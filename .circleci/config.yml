version: 2.1

workflows:
  simple_sign_workflow:
    jobs:
      - simple_sign_and_upload:
          filters:
            branches:
              only: [main, simple-sign]

jobs:
  simple_sign_and_upload:
    macos:
      xcode: "16.0.0"
    resource_class: macos.m1.medium.gen1
    
    steps:
      - checkout
      
      - run:
          name: "Setup Node.js and Capacitor"
          command: |
            # Install Node.js dependencies and Capacitor CLI
            echo "ðŸ“¦ Installing Node.js dependencies..."
            npm install
            npm install -g @capacitor/cli
            
            echo "âœ… Node.js and Capacitor setup complete"
      
      - run:
          name: "Setup Environment and Upload to App Store"
          command: |
            set -e
            
            # Read configuration
            APPLE_TEAM_ID=$(cat team.id | tr -d '\n\r' | head -1)
            APPLE_ID=$(cat apple.id | tr -d '\n\r' | head -1)
            API_KEY_ID=$(cat AuthKey_ZA7M4DJPV8.id | tr -d '\n\r' | head -1)
            
            # Check if apple.id contains Apple ID (numeric) or Issuer ID (UUID)
            if [[ "$APPLE_ID" =~ ^[0-9]+$ ]]; then
              echo "âš ï¸ WARNING: apple.id contains Apple ID ($APPLE_ID), not Issuer ID"
              echo "ðŸ” Issuer ID should be a UUID like: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
              echo "ðŸ“‹ Find it at: https://appstoreconnect.apple.com/access/api"
              echo ""
              echo "ðŸ”§ For now, using placeholder - THIS WILL FAIL UNTIL FIXED"
              ISSUER_ID="PLACEHOLDER-NEED-REAL-ISSUER-ID-UUID"
            else
              ISSUER_ID="$APPLE_ID"
            fi
            
            echo "ðŸš€ Starting App Store Connect upload"
            echo "ðŸ“‹ Configuration:"
            echo "  Team ID: $APPLE_TEAM_ID"
            echo "  Apple ID: $APPLE_ID" 
            echo "  Issuer ID: $ISSUER_ID"
            echo "  API Key ID: $API_KEY_ID"
            
            # Setup keychain
            echo "ðŸ” Setting up keychain..."
            if ! security list-keychains | grep -q "build.keychain"; then
              security create-keychain -p "" build.keychain
            fi
            security list-keychains -s build.keychain
            security default-keychain -s build.keychain
            security unlock-keychain -p "" build.keychain
            security set-keychain-settings -t 3600 -l build.keychain
            
            # Set partition list to allow codesign access without prompting
            echo "ðŸ” Configuring keychain access for codesign..."
            security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain || echo "Partition list setup completed"
            
            # Install certificates
            echo "ðŸ” Installing certificates..."
            if [ -f "auto_distribution.cer" ]; then
              security import auto_distribution.cer -k build.keychain -T /usr/bin/codesign
            fi
            if [ -f "auto_distribution_private_key.pem" ]; then
              security import auto_distribution_private_key.pem -k build.keychain -T /usr/bin/codesign
            fi
            
            # Verify signing identity
            echo "ðŸ” Available signing identities:"
            security find-identity -v -p codesigning build.keychain
            
            # Extract and prepare IPA with proper framework signing
            echo "ðŸ“¦ Preparing IPA from signed archive..."
            if [ ! -f "signed-ipa.zip" ]; then
              echo "âŒ ERROR: signed-ipa.zip not found!"
              echo "ðŸ”§ Attempting to use upload-to-appstore.sh script instead..."
              if [ -f "upload-to-appstore.sh" ]; then
                echo "âœ… Found upload-to-appstore.sh, delegating to it..."
                chmod +x upload-to-appstore.sh
                ./upload-to-appstore.sh
                exit $?
              else
                echo "âŒ No upload script found either!"
                exit 1
              fi
            fi
            
            echo "âœ… Found signed-ipa.zip"
            unzip -o signed-ipa.zip
            
            if [ ! -d "Payload" ]; then
              echo "âŒ ERROR: No Payload directory found!"
              exit 1
            fi
            
            if [ ! -d "Payload/App.app" ]; then
              echo "âŒ ERROR: No App.app found in Payload!"
              exit 1
            fi
            
            echo "âœ… Valid app structure found"
            
                        # CRITICAL: Follow Apple's modern best practices for iOS app signing
            echo "ðŸ” Following Apple's modern best practices for iOS app signing..."
            
            # Remove existing artifacts
            echo "ðŸ§¹ Removing existing artifacts..."
            rm -f App.ipa
            rm -rf Payload
            
            # Build and archive using Xcode's native process
            echo "ðŸ“¦ Building and archiving app using Xcode's native process..."
            
            # Sync Capacitor project first (required for proper iOS setup)
            echo "ðŸ”„ Syncing Capacitor project..."
            npx cap sync ios
            
            cd ios/App
            
            # Install CocoaPods dependencies (required for Capacitor projects)
            echo "ðŸ“¦ Installing CocoaPods dependencies..."
            pod install --repo-update
            
            # Clean previous builds
            echo "ðŸ”§ Cleaning previous builds..."
            xcodebuild clean -project App.xcodeproj -scheme App -configuration Release
            
            # Build and create archive (Apple's recommended approach)
            echo "ðŸ”§ Building and creating archive..."
            xcodebuild archive \
              -project App.xcodeproj \
              -scheme App \
              -configuration Release \
              -destination generic/platform=iOS \
              -archivePath App.xcarchive \
              DEVELOPMENT_TEAM="$APPLE_TEAM_ID" \
              PRODUCT_BUNDLE_IDENTIFIER="com.qaonline.app" \
              CODE_SIGN_STYLE="Automatic" \
              CURRENT_PROJECT_VERSION="38" \
              MARKETING_VERSION="1.0.72"
            
            # Export for App Store distribution using automatic signing
            echo "ðŸ“¦ Exporting for App Store distribution..."
            xcodebuild -exportArchive \
              -archivePath App.xcarchive \
              -exportPath . \
              -exportOptionsPlist exportOptions.plist
            
            # Verify the exported IPA exists
            if [ -f "App.ipa" ]; then
              mv App.ipa ../../App.ipa
              echo "âœ… Successfully built and exported IPA using Apple's best practices"
            else
              echo "âŒ Failed to export IPA - checking for errors..."
              ls -la
              exit 1
            fi
            
            cd ../..
            
            # Verify the IPA structure
            echo "ðŸ” Verifying IPA structure..."
            unzip -t App.ipa
            echo "âœ… IPA structure verified"
            
            # Verify the IPA is properly signed and ready for upload
            echo "ðŸ” Verifying IPA is ready for App Store Connect..."
            if [ -f "App.ipa" ]; then
              echo "âœ… IPA file created successfully: $(ls -lh App.ipa)"
              
              # Verify the IPA structure
              echo "ðŸ” Verifying IPA structure..."
              unzip -t App.ipa > /dev/null
              echo "âœ… IPA structure verified"
            else
              echo "âŒ ERROR: Failed to create IPA!"
              exit 1
            fi
            
            if [ ! -f "App.ipa" ]; then
              echo "âŒ ERROR: Failed to create IPA!"
              exit 1
            fi
            
            echo "âœ… IPA created: $(ls -lh App.ipa)"
            rm -rf Payload/
            
            # Install fastlane and required dependencies
            echo "ðŸ“¦ Installing Fastlane and dependencies..."
            sudo gem install fastlane --no-document
            pip3 install PyJWT requests
            
            # Upload to App Store Connect
            echo "ðŸš€ Uploading to App Store Connect..."
            
            if [ ! -f "AuthKey_${API_KEY_ID}.p8" ]; then
              echo "âŒ ERROR: API key file AuthKey_${API_KEY_ID}.p8 not found!"
              exit 1
            fi
            
            echo "ðŸ“± Uploading IPA: $(ls -lh App.ipa)"
            echo "ðŸ”‘ Using API Key: $API_KEY_ID"
            echo "ðŸ¢ Issuer ID: $ISSUER_ID"
            
            # Debug API key format
            echo "ðŸ” API Key format check:"
            head -1 "AuthKey_${API_KEY_ID}.p8" || echo "Cannot read API key file"
            
            # Create directory for API key (required by altool)
            mkdir -p ~/.appstoreconnect/private_keys
            cp "AuthKey_${API_KEY_ID}.p8" ~/.appstoreconnect/private_keys/
            
                        # Use Apple's modern best practices for App Store Connect upload
            echo "ðŸš€ Uploading to App Store Connect using Apple's modern best practices..."
            
            # First validate the app (Apple's recommended approach)
            echo "ðŸ” Validating app before upload..."
            if xcrun altool --validate-app \
              --type ios \
              --file "$(pwd)/App.ipa" \
              --apiKey "$API_KEY_ID" \
              --apiIssuer "$ISSUER_ID" \
              --verbose; then
              echo "âœ… App validation successful"
            else
              echo "âŒ App validation failed - checking for issues..."
              echo "ðŸ” This could indicate signing or configuration problems"
              echo "ðŸ“‹ Common issues:"
              echo "   - Bundle ID mismatch"
              echo "   - Invalid signing certificate"
              echo "   - Missing provisioning profile"
              echo "   - SDK version requirements"
              exit 1
            fi
            
            # Upload to App Store Connect using modern API key approach
            echo "ðŸš€ Uploading to App Store Connect..."
            if xcrun altool --upload-app \
              --type ios \
              --file "$(pwd)/App.ipa" \
              --apiKey "$API_KEY_ID" \
              --apiIssuer "$ISSUER_ID" \
              --verbose; then
              echo "ðŸŽ‰ SUCCESS: App uploaded to App Store Connect!"
              echo "ðŸ“± Your app is now processing in App Store Connect"
              echo "ðŸ”— Check status at: https://appstoreconnect.apple.com"
              echo "ðŸ“² Once processing completes, it will be available in TestFlight"
            else
              echo "âŒ Upload failed!"
              echo ""
              echo "ðŸ” TROUBLESHOOTING GUIDE:"
              echo "ðŸ“‹ 1. Check API key permissions in App Store Connect:"
              echo "   - Go to Users and Access > Keys"
              echo "   - Ensure key has 'App Manager' or 'Admin' role"
              echo "   - Verify 'Access to App Store Connect API' is enabled"
              echo ""
              echo "ðŸ“‹ 2. Check API key status:"
              echo "   - Ensure key is not expired"
              echo "   - Verify key is still active"
              echo ""
              echo "ðŸ“‹ 3. Check app configuration:"
              echo "   - Verify bundle ID matches App Store Connect"
              echo "   - Ensure app exists in App Store Connect"
              echo "   - Check if app record exists for 'com.qaonline.app'"
              echo ""
              echo "ðŸ“‹ 4. Check signing configuration:"
              echo "   - Verify automatic signing is working"
              echo "   - Check team ID is correct"
              echo "   - Ensure provisioning profile is valid"
              echo ""
              exit 1
            fi
            
            echo "ðŸŽ‰ UPLOAD COMPLETE!"
            echo "ðŸ“± Your app is now processing in App Store Connect"
            echo "ðŸ”— Check status at: https://appstoreconnect.apple.com"
            echo "ðŸ“² Once processing completes, it will be available in TestFlight"
            
            # Cleanup
            rm -f App.ipa
            security delete-keychain build.keychain || echo "Keychain cleanup done"
