version: 2.1

workflows:
  simple_sign_workflow:
    jobs:
      - simple_sign_and_upload:
          filters:
            branches:
              only: [main, simple-sign]

jobs:
  simple_sign_and_upload:
    macos:
      xcode: "15.3.0"
    resource_class: macos.m1.medium.gen1
    
    steps:
      - checkout
      
      - run:
          name: "Setup Environment and Upload to App Store"
          command: |
            set -e
            
            # Read configuration
            APPLE_TEAM_ID=$(cat team.id | tr -d '\n\r' | head -1)
            APPLE_ID=$(cat apple.id | tr -d '\n\r' | head -1)
            API_KEY_ID=$(cat AuthKey_ZA7M4DJPV8.id | tr -d '\n\r' | head -1)
            
            echo "ğŸš€ Starting App Store Connect upload"
            echo "ğŸ“‹ Configuration:"
            echo "  Team ID: $APPLE_TEAM_ID"
            echo "  Apple ID: $APPLE_ID" 
            echo "  API Key ID: $API_KEY_ID"
            
            # Setup keychain
            echo "ğŸ” Setting up keychain..."
            if ! security list-keychains | grep -q "build.keychain"; then
              security create-keychain -p "" build.keychain
            fi
            security list-keychains -s build.keychain
            security default-keychain -s build.keychain
            security unlock-keychain -p "" build.keychain
            security set-keychain-settings build.keychain
            
            # Install certificates
            echo "ğŸ” Installing certificates..."
            if [ -f "auto_distribution.cer" ]; then
              security import auto_distribution.cer -k build.keychain -T /usr/bin/codesign
            fi
            if [ -f "auto_distribution_private_key.pem" ]; then
              security import auto_distribution_private_key.pem -k build.keychain -T /usr/bin/codesign
            fi
            
            # Verify signing identity
            echo "ğŸ” Available signing identities:"
            security find-identity -v -p codesigning build.keychain
            
            # Extract and prepare IPA
            echo "ğŸ“¦ Preparing IPA from signed archive..."
            if [ ! -f "signed-ipa.zip" ]; then
              echo "âŒ ERROR: signed-ipa.zip not found!"
              exit 1
            fi
            
            echo "âœ… Found signed-ipa.zip"
            unzip -o signed-ipa.zip
            
            if [ ! -d "Payload" ]; then
              echo "âŒ ERROR: No Payload directory found!"
              exit 1
            fi
            
            if [ ! -d "Payload/App.app" ]; then
              echo "âŒ ERROR: No App.app found in Payload!"
              exit 1
            fi
            
            echo "âœ… Valid app structure found"
            
            # Verify executable
            if [ -f "Payload/App.app/App" ]; then
              EXEC_TYPE=$(file Payload/App.app/App)
              echo "ğŸ” Executable type: $EXEC_TYPE"
              if echo "$EXEC_TYPE" | grep -q "Mach-O"; then
                echo "âœ… Valid iOS executable"
              fi
            fi
            
            # Create IPA
            echo "ğŸ“¦ Creating final IPA..."
            zip -r App.ipa Payload/
            
            if [ ! -f "App.ipa" ]; then
              echo "âŒ ERROR: Failed to create IPA!"
              exit 1
            fi
            
            echo "âœ… IPA created: $(ls -lh App.ipa)"
            rm -rf Payload/
            
            # Install fastlane
            echo "ğŸ“¦ Installing Fastlane..."
            sudo gem install fastlane --no-document
            
            # Upload to App Store Connect
            echo "ğŸš€ Uploading to App Store Connect..."
            
            if [ ! -f "AuthKey_${API_KEY_ID}.p8" ]; then
              echo "âŒ ERROR: API key file AuthKey_${API_KEY_ID}.p8 not found!"
              exit 1
            fi
            
            echo "ğŸ“± Uploading IPA: $(ls -lh App.ipa)"
            
            # Try fastlane first
            echo "ğŸš€ Attempting upload with Fastlane..."
            if fastlane run upload_to_app_store \
              ipa:"App.ipa" \
              api_key_path:"AuthKey_${API_KEY_ID}.p8" \
              api_key:"$API_KEY_ID" \
              issuer_id:"6751101564" \
              skip_waiting_for_build_processing:true \
              skip_metadata:true \
              skip_screenshots:true \
              force:true; then
              echo "ğŸ‰ SUCCESS: App uploaded to App Store Connect via Fastlane!"
            else
              echo "âš ï¸ Fastlane failed, trying altool..."
              if xcrun altool --upload-app \
                --file "App.ipa" \
                --type ios \
                --apiKey "$API_KEY_ID" \
                --apiIssuer "6751101564" \
                --verbose; then
                echo "ğŸ‰ SUCCESS: App uploaded to App Store Connect via altool!"
              else
                echo "âŒ Both upload methods failed!"
                exit 1
              fi
            fi
            
            echo "ğŸ‰ UPLOAD COMPLETE!"
            echo "ğŸ“± Your app is now processing in App Store Connect"
            echo "ğŸ”— Check status at: https://appstoreconnect.apple.com"
            echo "ğŸ“² Once processing completes, it will be available in TestFlight"
            
            # Cleanup
            rm -f App.ipa
            security delete-keychain build.keychain || echo "Keychain cleanup done"
