version: 2.1

# Use CircleCI's macOS executors for iOS signing
executors:
  macos:
    macos:
      xcode: "15.2.0"

# Define reusable commands
commands:
  setup_xcode:
    description: "Setup Xcode environment"
    steps:
      - run:
          name: "Setup Xcode"
          command: |
            echo "ğŸ”§ Setting up Xcode..."
            xcodebuild -version
            sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

# Define the signing job
jobs:
  sign_existing_ipa:
    executor: macos
    steps:
      - checkout
      - setup_xcode
      
      - run:
          name: "Check for unsigned IPA"
          command: |
            echo "ğŸ“¥ Looking for unsigned IPA..."
            
            # Check if we have the IPA from a previous build
            if [ -f "ios/App/App.ipa" ]; then
              echo "âœ… Found App.ipa from previous build"
              ls -la ios/App/App.ipa
              cp ios/App/App.ipa App.ipa
            else
              echo "âŒ App.ipa not found from previous build"
              echo "ğŸ“¥ Please ensure the unsigned IPA is available"
              echo "ğŸ”— You can download it from: https://app.circleci.com/pipelines/github/QAI-O/qa-app-ios"
              echo "ğŸ“± Look for the 'ios-app-store-build' artifact"
              echo ""
              echo "ğŸ“‹ To use this pipeline:"
              echo "1. Download the unsigned App.ipa from your previous build"
              echo "2. Place it in the ios/App/ directory"
              echo "3. Run this pipeline"
              exit 1
            fi
      
      - run:
          name: "Setup certificates and profiles"
          command: |
            echo "ğŸ” Setting up certificates and profiles..."
            
            # Install the existing provisioning profile
            if [ -f "QAOnlineAppStoreProfile.mobileprovision" ]; then
              echo "ğŸ“„ Installing existing provisioning profile..."
              mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
              cp QAOnlineAppStoreProfile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
              echo "âœ… Provisioning profile installed"
            else
              echo "âŒ Provisioning profile not found"
              echo "ğŸ“¥ Please ensure QAOnlineAppStoreProfile.mobileprovision is in the project root"
              exit 1
            fi
            
            # Install the P12 certificate
            if [ -f "ios_distribution.p12" ]; then
              echo "ğŸ” Installing P12 certificate..."
              security import ios_distribution.p12 -k ~/Library/Keychains/login.keychain-db -T /usr/bin/codesign
              echo "âœ… P12 certificate installed"
            else
              echo "âŒ P12 certificate not found"
              echo "ğŸ“¥ Please ensure ios_distribution.p12 is in the project root"
              exit 1
            fi
            
            # Show available signing identities
            echo "ğŸ” Available signing identities:"
            security find-identity -v -p codesigning ~/Library/Keychains/login.keychain-db
      
      - run:
          name: "Sign the IPA"
          command: |
            echo "ğŸ” Signing the IPA..."
            
            # Extract the IPA
            echo "ğŸ“¦ Extracting IPA..."
            unzip -q App.ipa -d Payload/
            
            # Sign the app bundle
            echo "ğŸ” Signing app bundle..."
            codesign --force --sign "iPhone Distribution" --entitlements QAOnlineAppStoreProfile.mobileprovision Payload/App.app
            
            # Verify the signature
            echo "ğŸ” Verifying signature..."
            codesign -dv --verbose=4 Payload/App.app
            
            # Recreate the signed IPA
            echo "ğŸ“¦ Creating signed IPA..."
            rm -f App.ipa
            zip -r App-signed.ipa Payload/
            
            # Clean up
            rm -rf Payload/
            
            echo "âœ… IPA signed successfully!"
            ls -la App-signed.ipa
            echo "ğŸ“Š File size: $(ls -la App-signed.ipa | awk '{print $5}')"
            echo ""
            echo "ğŸ‰ Successfully created signed IPA!"
            echo "ğŸ“± The signed IPA is ready for manual upload to App Store Connect"
      
      - store_artifacts:
          path: App-signed.ipa
          destination: signed-ipa

# Define workflows
workflows:
  version: 2
  
  # Sign IPA workflow - manual trigger only
  sign_ipa_workflow:
    jobs:
      - sign_existing_ipa:
          filters:
            branches:
              ignore: /.*/
